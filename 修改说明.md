# changeoradd 集成说明

/moltbot/extensions 目录复制粘贴放入 /workspace-editor 文件

### 修改文件 (Modified)

| 文件 | 新增行数 | 修改内容 |
|------|----------|----------|
| `ui/src/styles.css` | +1 | 导入 model-config.css |
| `ui/src/ui/navigation.ts` | +10 | 添加 model-config 标签页 |
| `ui/src/ui/app.ts` | +46 | 添加模型配置状态属性（含 workspaceExpandedFolders） |
| `ui/src/ui/app-view-state.ts` | +53 | 添加状态类型定义（含 workspaceExpandedFolders） |
| `ui/src/ui/app-settings.ts` | +4 | 添加标签页刷新逻辑 |
| `ui/src/ui/app-render.ts` | +172 | 添加渲染逻辑和回调绑定（含文件夹展开回调） |
| `extensions/workspace-editor/workspace-files.ts` | +65 | 支持 memory/ 目录和可折叠文件夹 |
| **合计** | **+351** | |

---

## 详细集成点

### 1. 样式导入

**文件**: `ui/src/styles.css`

```css
@import "./ui/changeoradd/styles/model-config.css";
```

---

### 2. 导航配置

**文件**: `ui/src/ui/navigation.ts`

#### 2.1 添加到 TAB_GROUPS

```typescript
// 原始
{ label: "Settings", tabs: ["config", "debug", "logs"] },

// 修改后
{ label: "Settings", tabs: ["model-config", "config", "debug", "logs"] },
```

#### 2.2 添加 Tab 类型

```typescript
export type Tab =
  | ...
  | "model-config"  // 新增
  | "config"
  | ...
```

#### 2.3 添加路径映射

```typescript
const TAB_PATHS: Record<Tab, string> = {
  ...
  "model-config": "/model-config",
  ...
};
```

#### 2.4 添加图标

```typescript
export function iconForTab(tab: Tab): IconName {
  ...
  case "model-config":
    return "brain";
  ...
}
```

#### 2.5 添加标题和副标题

```typescript
export function titleForTab(tab: Tab) {
  ...
  case "model-config":
    return "可视化配置";
  ...
}

export function subtitleForTab(tab: Tab) {
  ...
  case "model-config":
    return "可视化管理模型供应商、Agent 默认设置和网关配置";
  ...
}
```

---

### 3. 应用状态

**文件**: `ui/src/ui/app.ts`

#### 3.1 导入类型

```typescript
import type {
  ProviderConfig,
  AgentDefaults,
  GatewayConfig,
} from "./changeoradd/views/model-config";
```

#### 3.2 添加状态属性 (@state)

```typescript
// 模型配置页面状态
@state() modelConfigLoading = false;
@state() modelConfigSaving = false;
@state() modelConfigApplying = false;
@state() modelConfigProviders: Record<string, ProviderConfig> = {};
@state() modelConfigAgentDefaults: AgentDefaults = {};
@state() modelConfigGateway: GatewayConfig = {};
@state() modelConfigExpandedProviders: Set<string> = new Set();
@state() modelConfigOriginal: { ... } | null = null;
@state() modelConfigFullSnapshot: Record<string, unknown> | null = null;
@state() modelConfigHash: string | null = null;
@state() modelConfigActiveSection: "providers" | "agent" | "gateway" | "channels" | "permissions" = "providers";

// 通道配置
@state() modelConfigChannelsConfig: Record<string, unknown> | null = null;
@state() modelConfigSelectedChannel: string | null = null;

// 权限管理状态
@state() permissionsLoading = false;
@state() permissionsSaving = false;
@state() permissionsDirty = false;
@state() permissionsSelectedAgent: string | null = null;
@state() permissionsActiveTab: PermissionsTabId = "exec";

// 工具权限状态
@state() toolsConfig: ToolsConfig | null = null;
@state() toolsConfigOriginal: ToolsConfig | null = null;
@state() agentToolsConfigs: AgentWithTools[] = [];
@state() agentToolsConfigsOriginal: AgentWithTools[] = [];
@state() toolsSelectedAgent: string | null = null;
@state() toolsExpanded = false;

// 会话管理状态
@state() agentSessionsLoading = false;
@state() agentSessionsResult: SessionsListResult | null = null;
@state() agentSessionsError: string | null = null;

// 工作区文件状态
@state() workspaceFiles: WorkspaceFileInfo[] = [];
@state() workspaceDir = "";
@state() workspaceAgentId = "main";
@state() workspaceSelectedFile: string | null = null;
@state() workspaceEditorContent = "";
@state() workspaceOriginalContent = "";
@state() workspaceLoading = false;
@state() workspaceSaving = false;
@state() workspaceError: string | null = null;
@state() workspaceEditorMode: "edit" | "preview" | "split" = "edit";
@state() workspaceExpandedFolders: Set<string> = new Set();
```

---

### 4. 状态类型定义

**文件**: `ui/src/ui/app-view-state.ts`

#### 4.1 导入类型

```typescript
import type {
  ProviderConfig,
  AgentDefaults,
  GatewayConfig,
} from "./changeoradd/views/model-config";

import type {
  ToolsConfig,
  AgentWithTools,
  PermissionsTabId,
  SessionsListResult as AgentSessionsListResult,
  AgentIdentityEntry,
  WorkspaceFileInfo,
} from "./changeoradd/controllers/model-config";

import type { ConfigSectionId } from "./changeoradd/types/config-sections";
import type { ChannelsConfigData } from "./changeoradd/types/channel-config";
```

#### 4.2 添加到 AppViewState 类型

```typescript
export type AppViewState = {
  ...
  // 模型配置状态
  modelConfigLoading: boolean;
  modelConfigSaving: boolean;
  modelConfigApplying: boolean;
  modelConfigProviders: Record<string, ProviderConfig>;
  modelConfigAgentDefaults: AgentDefaults;
  modelConfigGateway: GatewayConfig;
  modelConfigExpandedProviders: Set<string>;
  modelConfigOriginal: { ... } | null;
  modelConfigFullSnapshot: Record<string, unknown> | null;
  modelConfigHash: string | null;
  modelConfigActiveSection: ConfigSectionId;
  modelConfigChannelsConfig: ChannelsConfigData | null;
  modelConfigSelectedChannel: string | null;
  // 权限管理状态
  permissionsLoading: boolean;
  permissionsSaving: boolean;
  permissionsDirty: boolean;
  permissionsSelectedAgent: string | null;
  permissionsActiveTab: PermissionsTabId;
  // 工具权限状态
  toolsConfig: ToolsConfig | null;
  toolsConfigOriginal: ToolsConfig | null;
  agentToolsConfigs: AgentWithTools[];
  agentToolsConfigsOriginal: AgentWithTools[];
  toolsSelectedAgent: string | null;
  toolsExpanded: boolean;
  // 会话管理状态
  agentSessionsLoading: boolean;
  agentSessionsResult: AgentSessionsListResult | null;
  agentSessionsError: string | null;
  // 工作区文件状态
  workspaceFiles: WorkspaceFileInfo[];
  workspaceDir: string;
  workspaceAgentId: string;
  workspaceSelectedFile: string | null;
  workspaceEditorContent: string;
  workspaceOriginalContent: string;
  workspaceLoading: boolean;
  workspaceSaving: boolean;
  workspaceError: string | null;
  workspaceEditorMode: "edit" | "preview" | "split";
  workspaceExpandedFolders: Set<string>;
  ...
};
```

---

### 5. 标签页刷新

**文件**: `ui/src/ui/app-settings.ts`

#### 5.1 导入控制器

```typescript
import { loadModelConfig, loadAgentSessions } from "./changeoradd/controllers/model-config";
```

#### 5.2 添加刷新逻辑

```typescript
export async function refreshActiveTab(host: SettingsHost) {
  ...
  if (host.tab === "model-config") {
    await loadModelConfig(host as unknown as MoltbotApp);
  }
  ...
}
```

---

### 6. 渲染逻辑

**文件**: `ui/src/ui/app-render.ts`

#### 6.1 导入视图和控制器

```typescript
import { renderModelConfig } from "./changeoradd/views/model-config";

import {
  loadModelConfig,
  saveModelConfig,
  applyModelConfig,
  toggleProviderExpanded,
  addProvider,
  removeProvider,
  renameProvider,
  updateProviderField,
  addModel,
  removeModel,
  updateModelField,
  updateAgentDefaults,
  updateGatewayConfig,
  getAvailableModels,
  hasModelConfigChanges,
  setActiveSection,
  getPermissionsAgents,
  loadPermissions,
  savePermissions,
  selectPermissionsAgent,
  updatePermissionsFormValue,
  removePermissionsFormValue,
  addPermissionsAllowlistEntry,
  removePermissionsAllowlistEntry,
  addPermissionsAgent,
  removePermissionsAgent,
  setPermissionsActiveTab,
  resolveExecApprovalsNodes,
  getToolsAgents,
  selectToolsAgent,
  toggleToolsExpanded,
  updateGlobalToolsConfig,
  updateAgentToolsConfig,
  addGlobalToolsDenyEntry,
  removeGlobalToolsDenyEntry,
  addAgentToolsDenyEntry,
  removeAgentToolsDenyEntry,
  loadAgentSessions,
  patchSessionModel,
  loadWorkspaceFiles,
  selectWorkspaceFile,
  saveWorkspaceFile,
  createWorkspaceFile,
} from "./changeoradd/controllers/model-config";
```

#### 6.2 工作区文件处理器函数

```typescript
function handleWorkspaceFileSelect(state: AppViewState, fileName: string): void {
  void selectWorkspaceFile(state as Parameters<typeof selectWorkspaceFile>[0], fileName);
}

function handleWorkspaceFileSave(state: AppViewState): void {
  void saveWorkspaceFile(state as Parameters<typeof saveWorkspaceFile>[0]);
}

function handleWorkspaceRefresh(state: AppViewState): void {
  void loadWorkspaceFiles(state as Parameters<typeof loadWorkspaceFiles>[0]);
}

function handleWorkspaceFileCreate(state: AppViewState, fileName: string): void {
  createWorkspaceFile(state as Parameters<typeof createWorkspaceFile>[0], fileName);
}
```

#### 6.3 添加渲染条件 (在 renderApp 函数中)

```typescript
${state.tab === "model-config"
  ? renderModelConfig({
      loading: state.modelConfigLoading,
      saving: state.modelConfigSaving,
      applying: state.modelConfigApplying,
      connected: state.connected,
      hasChanges: hasModelConfigChanges(state),
      providers: state.modelConfigProviders,
      agentDefaults: state.modelConfigAgentDefaults,
      gatewayConfig: state.modelConfigGateway,
      availableModels: getAvailableModels(state.modelConfigProviders),
      channelsConfig: state.modelConfigChannelsConfig ?? {},
      selectedChannel: state.modelConfigSelectedChannel,
      expandedProviders: state.modelConfigExpandedProviders,
      activeSection: state.modelConfigActiveSection,
      // 工作区文件
      workspaceFiles: state.workspaceFiles,
      workspaceDir: state.workspaceDir,
      workspaceAgentId: state.workspaceAgentId,
      workspaceSelectedFile: state.workspaceSelectedFile,
      workspaceEditorContent: state.workspaceEditorContent,
      workspaceOriginalContent: state.workspaceOriginalContent,
      workspaceLoading: state.workspaceLoading,
      workspaceSaving: state.workspaceSaving,
      workspaceError: state.workspaceError,
      workspaceEditorMode: state.workspaceEditorMode,
      onWorkspaceFileSelect: (fileName) => handleWorkspaceFileSelect(state, fileName),
      onWorkspaceContentChange: (content) => { state.workspaceEditorContent = content; },
      onWorkspaceFileSave: () => handleWorkspaceFileSave(state),
      onWorkspaceRefresh: () => handleWorkspaceRefresh(state),
      onWorkspaceModeChange: (mode) => { state.workspaceEditorMode = mode; },
      onWorkspaceFileCreate: (fileName) => handleWorkspaceFileCreate(state, fileName),
      // 文件夹展开/收起
      expandedFolders: state.workspaceExpandedFolders,
      onFolderToggle: (folderName) => {
        const next = new Set(state.workspaceExpandedFolders);
        if (next.has(folderName)) {
          next.delete(folderName);
        } else {
          next.add(folderName);
        }
        state.workspaceExpandedFolders = next;
      },
      // ... 其他 40+ props 和 callbacks
    })
  : nothing}
```

---

### 7. 后端 workspace-editor 扩展

**文件**: `extensions/workspace-editor/workspace-files.ts`

#### 7.1 新增 memory/ 目录支持

```typescript
const MEMORY_DIR = "memory";
const MEMORY_FILE_PATTERN = /^\d{4}-\d{2}-\d{2}\.md$/;

function isMemoryFilePath(fileName: string): boolean {
  if (!fileName.startsWith(`${MEMORY_DIR}/`)) {
    return false;
  }
  const baseName = fileName.slice(MEMORY_DIR.length + 1);
  return MEMORY_FILE_PATTERN.test(baseName);
}
```

#### 7.2 更新 validateFileName

```typescript
function validateFileName(fileName: string): void {
  // 拒绝路径遍历攻击
  if (fileName.includes("\\") || fileName.includes("..")) {
    throw new Error(`Invalid filename: ${fileName}`);
  }

  // 允许 memory/YYYY-MM-DD.md 格式
  if (isMemoryFilePath(fileName)) {
    return;
  }

  // 拒绝其他包含斜杠的路径
  if (fileName.includes("/")) {
    throw new Error(`Invalid filename: ${fileName}`);
  }

  // 白名单校验
  if (!ALLOWED_FILES.has(fileName)) {
    throw new Error(`File not allowed: ${fileName}`);
  }
}
```

#### 7.3 更新 listWorkspaceFiles - 扫描 memory/ 目录

```typescript
// 在遍历白名单文件之后，增加扫描 memory/ 目录
const memoryDir = path.join(workspaceDir, MEMORY_DIR);
try {
  const memoryFiles = await fs.readdir(memoryDir);
  for (const fileName of memoryFiles) {
    if (!MEMORY_FILE_PATTERN.test(fileName)) continue;

    const filePath = path.join(memoryDir, fileName);
    const relativeName = `${MEMORY_DIR}/${fileName}`;
    const stat = await fs.stat(filePath);
    if (stat.isFile()) {
      files.push({
        name: relativeName,
        path: filePath,
        exists: true,
        size: stat.size,
        modifiedAt: stat.mtimeMs,
      });
    }
  }
} catch {
  // memory/ 目录不存在
}

// 排序: memory/ 文件放在末尾，内部按日期倒序
files.sort((a, b) => {
  if (a.exists && !b.exists) return -1;
  if (!a.exists && b.exists) return 1;

  const aIsMemory = a.name.startsWith(`${MEMORY_DIR}/`);
  const bIsMemory = b.name.startsWith(`${MEMORY_DIR}/`);
  if (aIsMemory && !bIsMemory) return 1;
  if (!aIsMemory && bIsMemory) return -1;

  // memory 文件内部按日期倒序（最新的在前）
  if (aIsMemory && bIsMemory) {
    return b.name.localeCompare(a.name);
  }

  return a.name.localeCompare(b.name);
});
```

#### 7.4 更新 writeWorkspaceFile - 自动创建 memory/ 子目录

```typescript
// 原始: await fs.mkdir(workspaceDir, { recursive: true });
// 修改为: 使用 path.dirname 自动处理子目录
const fileDir = path.dirname(filePath);
await fs.mkdir(fileDir, { recursive: true });
```

---

## changeoradd 内部文件

### 目录结构

```
changeoradd/
├── README.md
├── INTEGRATION.md
├── 修改说明.md                   # 本文件
├── views/
│   └── model-config.ts         # 顶层视图 (导出类型 + renderModelConfig)
├── controllers/
│   ├── model-config.ts         # 业务逻辑 (1700+ 行, 40+ 导出函数)
│   └── workspace.ts            # 工作区文件操作辅助
├── components/
│   ├── config-sidebar.ts       # 左侧导航栏
│   ├── providers-content.ts    # 提供商管理
│   ├── agent-content.ts        # 代理设置
│   ├── gateway-content.ts      # 网关设置
│   ├── channels-content.ts     # 通道配置
│   ├── workspace-content.ts    # 工作区文件编辑器（含可折叠文件夹）
│   └── permissions-content.ts  # 权限管理
├── types/
│   ├── config-sections.ts      # 区域类型
│   └── channel-config.ts       # 通道配置类型
├── styles/
│   └── model-config.css        # 样式文件（含文件夹折叠样式）
```

### 导出清单

#### `views/model-config.ts`

**类型导出:**
- `ProviderConfig`
- `ModelConfig`
- `AgentDefaults`
- `GatewayConfig`
- `ModelConfigProps`

**函数导出:**
- `renderModelConfig(props: ModelConfigProps)`

#### `controllers/model-config.ts`

**类型导出:**
- `ToolsConfig`
- `AgentWithTools`
- `PermissionsTabId`
- `SessionsListResult`
- `AgentIdentityEntry`
- `WorkspaceFileInfo`
- `ExecApprovalsSnapshot`
- `ExecApprovalsFile`
- `ExecApprovalsTarget`
- `ExecApprovalsTargetNode`

**函数导出 (40+):**
- `loadModelConfig`, `saveModelConfig`, `applyModelConfig`
- `addProvider`, `removeProvider`, `renameProvider`, `updateProviderField`
- `addModel`, `removeModel`, `updateModelField`
- `updateAgentDefaults`, `updateGatewayConfig`
- `getAvailableModels`, `hasModelConfigChanges`
- `setActiveSection`, `toggleProviderExpanded`
- `loadPermissions`, `savePermissions`, `selectPermissionsAgent`
- `updatePermissionsFormValue`, `removePermissionsFormValue`
- `addPermissionsAllowlistEntry`, `removePermissionsAllowlistEntry`
- `addPermissionsAgent`, `removePermissionsAgent`
- `getPermissionsAgents`, `getToolsAgents`
- `selectToolsAgent`, `toggleToolsExpanded`
- `updateGlobalToolsConfig`, `updateAgentToolsConfig`
- `addGlobalToolsDenyEntry`, `removeGlobalToolsDenyEntry`
- `addAgentToolsDenyEntry`, `removeAgentToolsDenyEntry`
- `loadAgentSessions`, `patchSessionModel`
- `loadWorkspaceFiles`, `selectWorkspaceFile`, `saveWorkspaceFile`, `createWorkspaceFile`
- `resolveExecApprovalsNodes`

#### `components/workspace-content.ts`

**类型导出:**
- `WorkspaceFileInfo`
- `WorkspaceContentProps` (含 `expandedFolders`, `onFolderToggle`)

**函数导出:**
- `renderWorkspaceContent(props: WorkspaceContentProps)`

#### `types/config-sections.ts`

- `ConfigSection`
- `ConfigSectionId`

#### `types/channel-config.ts`

- `ChannelMeta`
- `ChannelConfigField`
- `ChannelsConfigData`
- 19+ 通道配置类型

---

## memory/ 目录功能说明

### 功能概述

支持在工作区的 `memory/` 目录下存放按日期命名的每日日志文件。

### 文件命名规则

- 目录: `memory/`
- 文件名格式: `YYYY-MM-DD.md` (例如 `memory/2026-01-30.md`)
- 正则校验: `/^\d{4}-\d{2}-\d{2}\.md$/`

### UI 交互

```
工作区文件
├── SOUL.md          人格定义 - 行为准则、语气风格、道德边界
├── IDENTITY.md      身份信息 - 名称、表情、头像、类型
├── MEMORY.md        持久记忆 - Agent 的长期记忆
└── > memory/  (3)   <-- 点击展开/收起
    ├── 2026-01-30.md   每日日志 - 2026年01月30日的记录
    ├── 2026-01-29.md   每日日志 - 2026年01月29日的记录
    └── 2026-01-28.md   每日日志 - 2026年01月28日的记录
```

- [+] 按钮: 一键创建今日日志文件
- 文件夹显示文件数量标签
- 子文件被选中时文件夹显示高亮边框
- memory 文件按日期倒序排列（最新在前）

### 安全性

- `..` 和 `\` 路径遍历被拒绝
- 仅允许 `memory/` 目录（不允许其他子目录）
- 仅允许 `YYYY-MM-DD.md` 格式的文件名
- 写入时自动创建 `memory/` 目录

---
