# changeoradd 集成说明

/moltbot/extensions 目录复制粘贴放入 /workspace-editor 文件

### 修改文件 (Modified)

| 文件 | 新增行数 | 修改内容 |
|------|----------|----------|
| `ui/src/styles.css` | +1 | 导入 model-config.css |
| `ui/src/ui/navigation.ts` | +10 | 添加 model-config 标签页 |
| `ui/src/ui/app.ts` | +45 | 添加模型配置状态属性 |
| `ui/src/ui/app-view-state.ts` | +52 | 添加状态类型定义 |
| `ui/src/ui/app-settings.ts` | +4 | 添加标签页刷新逻辑 |
| `ui/src/ui/app-render.ts` | +162 | 添加渲染逻辑和回调绑定 |
| **合计** | **+274** | |

---

## 详细集成点

### 1. 样式导入

**文件**: `ui/src/styles.css`

```css
@import "./ui/changeoradd/styles/model-config.css";
```

---

### 2. 导航配置

**文件**: `ui/src/ui/navigation.ts`

#### 2.1 添加到 TAB_GROUPS

```typescript
// 原始
{ label: "Settings", tabs: ["config", "debug", "logs"] },

// 修改后
{ label: "Settings", tabs: ["model-config", "config", "debug", "logs"] },
```

#### 2.2 添加 Tab 类型

```typescript
export type Tab =
  | ...
  | "model-config"  // 新增
  | "config"
  | ...
```

#### 2.3 添加路径映射

```typescript
const TAB_PATHS: Record<Tab, string> = {
  ...
  "model-config": "/model-config",
  ...
};
```

#### 2.4 添加图标

```typescript
export function iconForTab(tab: Tab): IconName {
  ...
  case "model-config":
    return "layers";
  ...
}
```

#### 2.5 添加标题和副标题

```typescript
export function titleForTab(tab: Tab) {
  ...
  case "model-config":
    return "模型配置";
  ...
}

export function subtitleForTab(tab: Tab) {
  ...
  case "model-config":
    return "可视化管理模型供应商、Agent 默认设置和网关配置";
  ...
}
```

---

### 3. 应用状态

**文件**: `ui/src/ui/app.ts`

#### 3.1 导入类型

```typescript
import type {
  ProviderConfig,
  AgentDefaults,
  GatewayConfig,
} from "./changeoradd/views/model-config";
```

#### 3.2 添加状态属性 (@state)

```typescript
// 模型配置页面状态
@state() modelConfigLoading = false;
@state() modelConfigSaving = false;
@state() modelConfigApplying = false;
@state() modelConfigProviders: Record<string, ProviderConfig> = {};
@state() modelConfigAgentDefaults: AgentDefaults = {};
@state() modelConfigGateway: GatewayConfig = {};
@state() modelConfigExpandedProviders: Set<string> = new Set();
@state() modelConfigOriginal: { ... } | null = null;
@state() modelConfigFullSnapshot: Record<string, unknown> | null = null;
@state() modelConfigHash: string | null = null;
@state() modelConfigActiveSection: "providers" | "agent" | "gateway" | "channels" | "permissions" = "providers";

// 通道配置
@state() modelConfigChannelsConfig: Record<string, unknown> | null = null;
@state() modelConfigSelectedChannel: string | null = null;

// 权限管理状态
@state() permissionsLoading = false;
@state() permissionsSaving = false;
@state() permissionsDirty = false;
@state() permissionsSelectedAgent: string | null = null;
@state() permissionsActiveTab: PermissionsTabId = "exec";

// 工具权限状态
@state() toolsConfig: ToolsConfig | null = null;
@state() toolsConfigOriginal: ToolsConfig | null = null;
@state() agentToolsConfigs: AgentWithTools[] = [];
@state() agentToolsConfigsOriginal: AgentWithTools[] = [];
@state() toolsSelectedAgent: string | null = null;
@state() toolsExpanded = false;

// 会话管理状态
@state() agentSessionsLoading = false;
@state() agentSessionsResult: SessionsListResult | null = null;
@state() agentSessionsError: string | null = null;
```

---

### 4. 状态类型定义

**文件**: `ui/src/ui/app-view-state.ts`

#### 4.1 导入类型

```typescript
import type {
  ProviderConfig,
  AgentDefaults,
  GatewayConfig,
} from "./changeoradd/views/model-config";

import type {
  ToolsConfig,
  AgentWithTools,
  PermissionsTabId,
  SessionsListResult as AgentSessionsListResult,
} from "./changeoradd/controllers/model-config";

import type { ConfigSectionId } from "./changeoradd/types/config-sections";
import type { ChannelsConfigData } from "./changeoradd/types/channel-config";
```

#### 4.2 添加到 AppViewState 类型

```typescript
export type AppViewState = {
  ...
  // 模型配置状态
  modelConfigLoading: boolean;
  modelConfigSaving: boolean;
  modelConfigApplying: boolean;
  modelConfigProviders: Record<string, ProviderConfig>;
  modelConfigAgentDefaults: AgentDefaults;
  modelConfigGateway: GatewayConfig;
  modelConfigExpandedProviders: Set<string>;
  modelConfigOriginal: { ... } | null;
  modelConfigFullSnapshot: Record<string, unknown> | null;
  modelConfigHash: string | null;
  modelConfigActiveSection: ConfigSectionId;
  modelConfigChannelsConfig: ChannelsConfigData | null;
  modelConfigSelectedChannel: string | null;
  // 权限管理状态
  permissionsLoading: boolean;
  permissionsSaving: boolean;
  permissionsDirty: boolean;
  permissionsSelectedAgent: string | null;
  permissionsActiveTab: PermissionsTabId;
  // 工具权限状态
  toolsConfig: ToolsConfig | null;
  toolsConfigOriginal: ToolsConfig | null;
  agentToolsConfigs: AgentWithTools[];
  agentToolsConfigsOriginal: AgentWithTools[];
  toolsSelectedAgent: string | null;
  toolsExpanded: boolean;
  // 会话管理状态
  agentSessionsLoading: boolean;
  agentSessionsResult: AgentSessionsListResult | null;
  agentSessionsError: string | null;
  ...
};
```

---

### 5. 标签页刷新

**文件**: `ui/src/ui/app-settings.ts`

#### 5.1 导入控制器

```typescript
import { loadModelConfig, loadAgentSessions } from "./changeoradd/controllers/model-config";
```

#### 5.2 添加刷新逻辑

```typescript
export async function refreshActiveTab(host: SettingsHost) {
  ...
  if (host.tab === "model-config") {
    await loadModelConfig(host as unknown as MoltbotApp);
  }
  ...
}
```

---

### 6. 渲染逻辑

**文件**: `ui/src/ui/app-render.ts`

#### 6.1 导入视图和控制器

```typescript
import { renderModelConfig } from "./changeoradd/views/model-config";

import {
  loadModelConfig,
  saveModelConfig,
  applyModelConfig,
  toggleProviderExpanded,
  addProvider,
  removeProvider,
  updateProviderField,
  addModel,
  removeModel,
  updateModelField,
  updateAgentDefaults,
  updateGatewayConfig,
  getAvailableModels,
  hasModelConfigChanges,
  setActiveSection,
  getPermissionsAgents,
  loadPermissions,
  savePermissions,
  selectPermissionsAgent,
  updatePermissionsFormValue,
  removePermissionsFormValue,
  addPermissionsAllowlistEntry,
  removePermissionsAllowlistEntry,
  getToolsAgents,
  selectToolsAgent,
  toggleToolsExpanded,
  updateGlobalToolsConfig,
  updateAgentToolsConfig,
  addGlobalToolsDenyEntry,
  removeGlobalToolsDenyEntry,
  addAgentToolsDenyEntry,
  removeAgentToolsDenyEntry,
  loadAgentSessions,
  patchSessionModel,
} from "./changeoradd/controllers/model-config";
```

#### 6.2 添加渲染条件 (在 renderApp 函数中)

```typescript
${state.tab === "model-config"
  ? renderModelConfig({
      loading: state.modelConfigLoading,
      saving: state.modelConfigSaving,
      applying: state.modelConfigApplying,
      connected: state.connected,
      hasChanges: hasModelConfigChanges(state),
      providers: state.modelConfigProviders,
      agentDefaults: state.modelConfigAgentDefaults,
      gatewayConfig: state.modelConfigGateway,
      availableModels: getAvailableModels(state.modelConfigProviders),
      channelsConfig: state.modelConfigChannelsConfig ?? {},
      selectedChannel: state.modelConfigSelectedChannel,
      expandedProviders: state.modelConfigExpandedProviders,
      activeSection: state.modelConfigActiveSection,
      // ... 40+ props 和 callbacks
    })
  : nothing}
```

---

## changeoradd 内部文件

### 目录结构

```
changeoradd/
├── README.md
├── INTEGRATION.md              # 本文件
├── views/
│   └── model-config.ts         # 顶层视图 (导出类型 + renderModelConfig)
├── controllers/
│   └── model-config.ts         # 业务逻辑 (1300+ 行, 40+ 导出函数)
├── components/
│   ├── config-sidebar.ts       # 左侧导航栏
│   ├── providers-content.ts    # 提供商管理
│   ├── agent-content.ts        # 代理设置
│   ├── gateway-content.ts      # 网关设置
│   ├── channels-content.ts     # 通道配置
│   └── permissions-content.ts  # 权限管理
└── types/
    ├── config-sections.ts      # 区域类型
    └── channel-config.ts       # 通道配置类型
```

### 导出清单

#### `views/model-config.ts`

**类型导出:**
- `ProviderConfig`
- `ModelConfig`
- `AgentDefaults`
- `GatewayConfig`
- `ModelConfigProps`

**函数导出:**
- `renderModelConfig(props: ModelConfigProps)`

#### `controllers/model-config.ts`

**类型导出:**
- `ToolsConfig`
- `AgentWithTools`
- `PermissionsTabId`
- `SessionsListResult`

**函数导出 (40+):**
- `loadModelConfig`, `saveModelConfig`, `applyModelConfig`
- `addProvider`, `removeProvider`, `updateProviderField`
- `addModel`, `removeModel`, `updateModelField`
- `updateAgentDefaults`, `updateGatewayConfig`
- `getAvailableModels`, `hasModelConfigChanges`
- `setActiveSection`, `toggleProviderExpanded`
- `loadPermissions`, `savePermissions`, `selectPermissionsAgent`
- `updatePermissionsFormValue`, `removePermissionsFormValue`
- `addPermissionsAllowlistEntry`, `removePermissionsAllowlistEntry`
- `getPermissionsAgents`, `getToolsAgents`
- `selectToolsAgent`, `toggleToolsExpanded`
- `updateGlobalToolsConfig`, `updateAgentToolsConfig`
- `addGlobalToolsDenyEntry`, `removeGlobalToolsDenyEntry`
- `addAgentToolsDenyEntry`, `removeAgentToolsDenyEntry`
- `loadAgentSessions`, `patchSessionModel`

#### `types/config-sections.ts`

- `ConfigSection`
- `ConfigSectionId`

#### `types/channel-config.ts`

- `ChannelMeta`
- `ChannelConfigField`
- `ChannelsConfigData`
- 19+ 通道配置类型

---
